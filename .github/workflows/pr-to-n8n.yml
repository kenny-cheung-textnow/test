name: PR â†’ n8n webhook

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  call-n8n:
    # Optional: avoid running on forked PRs (secrets aren't available there)
    # if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
    runs-on: ubuntu-latest
    steps:
      - name: Build JSON payload
        id: payload
        shell: bash
        run: |
          jq -n \
            --arg action     "${{ github.event.action }}" \
            --arg repo       "${{ github.repository }}" \
            --arg repo_url   "https://github.com/${{ github.repository }}" \
            --arg pr_number  "${{ github.event.number }}" \
            --arg pr_url     "${{ github.event.pull_request.html_url }}" \
            --arg base       "${{ github.event.pull_request.base.ref }}" \
            --arg head       "${{ github.event.pull_request.head.ref }}" \
            --arg by         "${{ github.event.pull_request.user.login }}" \
            '{action:$action,
              repo:$repo,
              repo_url:$repo_url,
              pr_number:($pr_number|tonumber),
              pr_url:$pr_url,
              base:$base,
              head:$head,
              by:$by}' > payload.json

          # Optional HMAC signature (keep only if you validate in n8n)
          if [ -n "${{ secrets.N8N_SHARED_SECRET }}" ]; then
            sig=$(openssl dgst -sha256 -hmac "${{ secrets.N8N_SHARED_SECRET }}" -binary payload.json | xxd -p -c 256)
            echo "signature=sha256=$sig" >> "$GITHUB_OUTPUT"
          fi

      - name: POST to n8n webhook (Header Auth)
        env:
          WEBHOOK_URL: ${{ secrets.N8N_WEBHOOK_URL }}
          WEBHOOK_AUTH: ${{ secrets.WEBHOOK_AUTH }}
          SIGNATURE: ${{ steps.payload.outputs.signature }}
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${WEBHOOK_URL:-}" ]; then
            echo "::error::N8N_WEBHOOK_URL secret is missing"; exit 1
          fi

          CURL_ARGS=(
            -sS -X POST
            -H "Content-Type: application/json"
            -H "X-GitHub-Event: pull_request"
            -H "Authorization: ${WEBHOOK_AUTH}"
            --retry 3 --retry-delay 2 --max-time 30
            --data @payload.json
            "${WEBHOOK_URL}"
          )

          # Add HMAC header if we computed one
          if [ -n "${SIGNATURE:-}" ]; then
            CURL_ARGS=(-H "X-Hub-Hmac-Sha256: ${SIGNATURE}" "${CURL_ARGS[@]}")
          fi

          curl "${CURL_ARGS[@]}"
